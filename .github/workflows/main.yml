name: Full CI-CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# -------------------------------------------------------
# 1) ORTAK HAZIRLIK
# -------------------------------------------------------
jobs:
  setup:
    name: üèó Setup Environment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

# -------------------------------------------------------
# 2) LINT
# -------------------------------------------------------
  lint:
    name: üîç Lint Check
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4
      - name: Run ESLint
        run: npm run lint

# -------------------------------------------------------
# 3) UNIT TESTS
# -------------------------------------------------------
  unit_tests:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4

      - name: Run Jest Tests
        run: npm test -- --ci --reporters=default --reporters=jest-junit
        env:
          CI: true

# -------------------------------------------------------
# 4) ACCESSIBILITY TESTS (Pa11y + Axe)
# -------------------------------------------------------
  accessibility:
    name: ‚ôø Accessibility Tests (Pa11y + Axe)
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4

      - name: Install Accessibility Tools
        run: |
          npm install -g pa11y
          npm install -g @axe-core/cli

      - name: Run Pa11y
        run: pa11y http://localhost:3000 --reporter html > pa11y-report.html || true

      - name: Run Axe Core
        run: axe http://localhost:3000 --save axe-report.json || true

      - name: Upload Accessibility Reports
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: |
            pa11y-report.html
            axe-report.json

# -------------------------------------------------------
# 5) LIGHTHOUSE AUDIT
# -------------------------------------------------------
  lighthouse:
    name: üö® Lighthouse Audit
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4
      
      - name: Install Lighthouse
        run: npm install -g @lhci/cli

      - name: Run Lighthouse
        run: lhci autorun || true

      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: ./.lighthouseci

# -------------------------------------------------------
# 6) BUILD
# -------------------------------------------------------
  build:
    name: üèó Build Project
    runs-on: ubuntu-latest
    needs:
      - lint
      - unit_tests
      - accessibility
      - lighthouse

    steps:
      - uses: actions/checkout@v4
      - name: Build Project
        run: npm run build

      - name: Upload Build Output
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: dist/

# -------------------------------------------------------
# 7) FRONTEND DEPLOY (Vercel)
# -------------------------------------------------------
  deploy_frontend:
    name: üöÄ Deploy Frontend (Vercel)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: .
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

# -------------------------------------------------------
# 8) BACKEND DEPLOY (Render)
# -------------------------------------------------------
  deploy_backend:
    name: üöÄ Deploy Backend (Render)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Trigger Render Deploy
        run: |
          curl -X POST \
          -H "Accept: application/json" \
          -H "Authorization: Bearer ${{ secrets.RENDER_DEPLOY_KEY }}" \
          https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys
